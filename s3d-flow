#!/bin/bash
set -e

flow_branch=$1
flow_branch=${flow_branch:-next}

v=$(s3d-flow-json | jq -r .latest)
v2=$(s3d-flow-json | jq -r .release)
if [[ $v == $v2 ]]; then
  s3d-flow-check
  if [[ $flow_branch != main ]]; then
    echo 'ERROR: Flow not started' >&2
    exit 1
  fi
fi
 
# Run local flow
if [[ 's3d-scripts' != "${PWD##*/}" ]]; then
  if [ -e ./s3d-flow ]; then
    ./s3d-flow
  fi
fi

# Commit, tag and push
s3d-flow-commit
s3d-flow-tag
git push ssh HEAD:$flow_branch

# Checkout a "Detatched" head
git checkout HEAD~0

